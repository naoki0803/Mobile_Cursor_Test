<div class="section-header">
    <h1><i class="bi bi-cloud-upload"></i> デプロイメント - 本番環境への安全なリリース</h1>
    <p class="lead">なぜ適切なデプロイメントが重要なのか、CI/CDパイプライン、Dockerコンテナ化、クラウドデプロイメントの実践手法を学習します</p>
</div>

<!-- なぜデプロイメントが重要なのか -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h2><i class="bi bi-exclamation-triangle-fill"></i> なぜ適切なデプロイメントが重要なのか？</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4><i class="bi bi-x-circle text-danger"></i> 不適切なデプロイメントのリスク</h4>
                        <div class="alert alert-danger">
                            <ul class="mb-0">
                                <li><strong>サービス停止</strong> - 顧客への影響とビジネス損失</li>
                                <li><strong>データ破損</strong> - 復旧困難な重大事故</li>
                                <li><strong>セキュリティホール</strong> - 設定ミスによる脆弱性</li>
                                <li><strong>品質低下</strong> - テスト不足によるバグ</li>
                                <li><strong>ロールバック困難</strong> - 迅速な復旧ができない</li>
                            </ul>
                        </div>
                        
                        <div class="deployment-stats">
                            <h6><i class="bi bi-graph-down"></i> デプロイメント失敗の統計</h6>
                            <div class="stat-item danger">
                                <span class="stat-number">21%</span>
                                <span class="stat-desc">手動デプロイメントの失敗率</span>
                            </div>
                            <div class="stat-item danger">
                                <span class="stat-number">4時間</span>
                                <span class="stat-desc">平均復旧時間</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4><i class="bi bi-check-circle text-success"></i> 自動化されたデプロイメントの効果</h4>
                        <div class="alert alert-success">
                            <ul class="mb-0">
                                <li><strong>安全性</strong> - 一貫したプロセスでミス削減</li>
                                <li><strong>効率性</strong> - 自動化による時間短縮</li>
                                <li><strong>品質保証</strong> - 自動テストによる品質確保</li>
                                <li><strong>監査性</strong> - 全変更履歴の記録</li>
                                <li><strong>スケーラビリティ</strong> - 複数環境への対応</li>
                            </ul>
                        </div>
                        
                        <div class="deployment-stats success">
                            <h6><i class="bi bi-graph-up"></i> CI/CDの効果</h6>
                            <div class="stat-item success">
                                <span class="stat-number">200倍</span>
                                <span class="stat-desc">デプロイメント頻度向上</span>
                            </div>
                            <div class="stat-item success">
                                <span class="stat-number">24倍</span>
                                <span class="stat-desc">復旧時間短縮</span>
                            </div>
                            <div class="stat-item success">
                                <span class="stat-number">3倍</span>
                                <span class="stat-desc">変更失敗率減少</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CI/CDパイプライン -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h2><i class="bi bi-arrow-repeat"></i> CI/CDパイプライン構築</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8">
                        <h4><i class="bi bi-diagram-3"></i> パイプライン フロー</h4>
                        <div class="pipeline-flow">
                            <div class="pipeline-stage">
                                <div class="stage-box commit">
                                    <i class="bi bi-git"></i>
                                    <h6>コミット</h6>
                                    <small>Git Push</small>
                                </div>
                                <div class="stage-arrow">→</div>
                            </div>
                            <div class="pipeline-stage">
                                <div class="stage-box build">
                                    <i class="bi bi-gear"></i>
                                    <h6>ビルド</h6>
                                    <small>Compile & Package</small>
                                </div>
                                <div class="stage-arrow">→</div>
                            </div>
                            <div class="pipeline-stage">
                                <div class="stage-box test">
                                    <i class="bi bi-check-circle"></i>
                                    <h6>テスト</h6>
                                    <small>Unit & Integration</small>
                                </div>
                                <div class="stage-arrow">→</div>
                            </div>
                            <div class="pipeline-stage">
                                <div class="stage-box deploy">
                                    <i class="bi bi-cloud-upload"></i>
                                    <h6>デプロイ</h6>
                                    <small>Staging & Production</small>
                                </div>
                            </div>
                        </div>
                        
                        <h5 class="mt-4"><i class="bi bi-file-code"></i> GitHub Actions設定例</h5>
                        <div class="code-block">
                            <pre><code class="language-yaml"># .github/workflows/deploy.yml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: '8.0.x'
  AZURE_WEBAPP_NAME: 'ecommerce-app'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --no-restore
    
    - name: Test
      run: dotnet test --no-build --verbosity normal --collect:"XPlat Code Coverage"
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Build and publish
      run: |
        dotnet restore
        dotnet build --configuration Release
        dotnet publish -c Release -o ${{env.DOTNET_ROOT}}/myapp
    
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ${{env.DOTNET_ROOT}}/myapp</code></pre>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <h4><i class="bi bi-list-check"></i> デプロイメント環境</h4>
                        <div class="environment-stages">
                            <div class="env-stage development">
                                <h6><i class="bi bi-code-slash"></i> 開発環境</h6>
                                <ul>
                                    <li>開発者の手元環境</li>
                                    <li>頻繁な変更</li>
                                    <li>デバッグ設定</li>
                                </ul>
                            </div>
                            <div class="env-stage staging">
                                <h6><i class="bi bi-search"></i> ステージング環境</h6>
                                <ul>
                                    <li>本番同等の設定</li>
                                    <li>統合テスト</li>
                                    <li>品質保証</li>
                                </ul>
                            </div>
                            <div class="env-stage production">
                                <h6><i class="bi bi-shield-check"></i> 本番環境</h6>
                                <ul>
                                    <li>顧客向けサービス</li>
                                    <li>高可用性</li>
                                    <li>監視・ログ</li>
                                </ul>
                            </div>
                        </div>
                        
                        <h5><i class="bi bi-gear-wide-connected"></i> 環境設定管理</h5>
                        <div class="code-block">
                            <pre><code class="language-json">{
  "ConnectionStrings": {
    "DefaultConnection": "#{ConnectionString}#"
  },
  "Jwt": {
    "Key": "#{JwtKey}#",
    "Issuer": "#{JwtIssuer}#"
  },
  "Logging": {
    "LogLevel": {
      "Default": "#{LogLevel}#"
    }
  }
}</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dockerコンテナ化 -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h2><i class="bi bi-box-seam"></i> Dockerコンテナ化</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4><i class="bi bi-file-docker"></i> Dockerfile作成</h4>
                        <div class="code-block">
                            <pre><code class="language-dockerfile"># Dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
WORKDIR /app
EXPOSE 80
EXPOSE 443

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY ["ECommerce.API/ECommerce.API.csproj", "ECommerce.API/"]
COPY ["ECommerce.Core/ECommerce.Core.csproj", "ECommerce.Core/"]
COPY ["ECommerce.Infrastructure/ECommerce.Infrastructure.csproj", "ECommerce.Infrastructure/"]

RUN dotnet restore "ECommerce.API/ECommerce.API.csproj"
COPY . .
WORKDIR "/src/ECommerce.API"
RUN dotnet build "ECommerce.API.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "ECommerce.API.csproj" -c Release -o /app/publish /p:UseAppHost=false

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .

# セキュリティ: 非rootユーザーで実行
RUN adduser --disabled-password --gecos '' appuser && chown -R appuser /app
USER appuser

ENTRYPOINT ["dotnet", "ECommerce.API.dll"]</code></pre>
                        </div>
                        
                        <h5><i class="bi bi-layers"></i> マルチステージビルド</h5>
                        <div class="docker-stages">
                            <div class="docker-stage">
                                <span class="stage-name">base</span>
                                <small>実行環境</small>
                            </div>
                            <div class="stage-arrow">→</div>
                            <div class="docker-stage">
                                <span class="stage-name">build</span>
                                <small>ビルド環境</small>
                            </div>
                            <div class="stage-arrow">→</div>
                            <div class="docker-stage">
                                <span class="stage-name">publish</span>
                                <small>発行</small>
                            </div>
                            <div class="stage-arrow">→</div>
                            <div class="docker-stage">
                                <span class="stage-name">final</span>
                                <small>最終イメージ</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4><i class="bi bi-stack"></i> Docker Compose</h4>
                        <div class="code-block">
                            <pre><code class="language-yaml"># docker-compose.yml
version: '3.8'

services:
  ecommerce-api:
    build: 
      context: .
      dockerfile: Dockerfile
    ports:
      - "5000:80"
      - "5001:443"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=ECommerceDB;User Id=sa;Password=${SA_PASSWORD};TrustServerCertificate=true
    depends_on:
      - sqlserver
      - redis
    networks:
      - ecommerce-network

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${SA_PASSWORD}
      - MSSQL_PID=Express
    ports:
      - "1433:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    networks:
      - ecommerce-network

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - ecommerce-network

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - ecommerce-api
    networks:
      - ecommerce-network

volumes:
  sqlserver-data:
  redis-data:

networks:
  ecommerce-network:
    driver: bridge</code></pre>
                        </div>
                        
                        <h5><i class="bi bi-terminal"></i> Dockerコマンド</h5>
                        <div class="code-block">
                            <pre><code class="language-bash"># イメージビルド
docker build -t ecommerce-api:latest .

# コンテナ実行
docker run -d -p 5000:80 --name ecommerce ecommerce-api

# Docker Compose起動
docker-compose up -d

# ログ確認
docker-compose logs -f ecommerce-api

# スケーリング
docker-compose up -d --scale ecommerce-api=3</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- クラウドデプロイメント -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h2><i class="bi bi-cloud"></i> クラウドデプロイメント</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h5><i class="bi bi-microsoft"></i> Azure App Service</h5>
                        <div class="code-block">
                            <pre><code class="language-bash"># Azure CLI デプロイ
az login

# リソースグループ作成
az group create --name rg-ecommerce --location japaneast

# App Service Plan作成
az appservice plan create \
  --name plan-ecommerce \
  --resource-group rg-ecommerce \
  --sku B1 --is-linux

# Web App作成
az webapp create \
  --resource-group rg-ecommerce \
  --plan plan-ecommerce \
  --name ecommerce-app-2024 \
  --runtime "DOTNETCORE:8.0"

# アプリケーション設定
az webapp config appsettings set \
  --resource-group rg-ecommerce \
  --name ecommerce-app-2024 \
  --settings @appsettings.json

# デプロイ
az webapp deployment source config \
  --name ecommerce-app-2024 \
  --resource-group rg-ecommerce \
  --repo-url https://github.com/username/repo \
  --branch main</code></pre>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h5><i class="bi bi-amazon"></i> AWS Elastic Beanstalk</h5>
                        <div class="code-block">
                            <pre><code class="language-bash"># AWS CLI デプロイ
aws configure

# Elastic Beanstalk アプリケーション作成
aws elasticbeanstalk create-application \
  --application-name ecommerce-app

# 環境作成
aws elasticbeanstalk create-environment \
  --application-name ecommerce-app \
  --environment-name prod \
  --solution-stack-name "64bit Amazon Linux 2 v2.1.1 running .NET Core"

# デプロイパッケージ作成
dotnet publish -c Release -o ./publish
cd publish && zip -r ../app.zip .

# アプリケーションバージョン作成
aws elasticbeanstalk create-application-version \
  --application-name ecommerce-app \
  --version-label v1.0 \
  --source-bundle S3Bucket=my-bucket,S3Key=app.zip

# 環境更新
aws elasticbeanstalk update-environment \
  --environment-name prod \
  --version-label v1.0</code></pre>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h5><i class="bi bi-google"></i> Google Cloud Run</h5>
                        <div class="code-block">
                            <pre><code class="language-bash"># Google Cloud デプロイ
gcloud auth login
gcloud config set project PROJECT_ID

# Container Registry有効化
gcloud services enable containerregistry.googleapis.com

# Dockerイメージビルド・プッシュ
docker build -t gcr.io/PROJECT_ID/ecommerce-api .
docker push gcr.io/PROJECT_ID/ecommerce-api

# Cloud Run デプロイ
gcloud run deploy ecommerce-api \
  --image gcr.io/PROJECT_ID/ecommerce-api \
  --platform managed \
  --region asia-northeast1 \
  --allow-unauthenticated \
  --set-env-vars="ASPNETCORE_ENVIRONMENT=Production"

# カスタムドメイン設定
gcloud run domain-mappings create \
  --service ecommerce-api \
  --domain api.ecommerce.com</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 監視とログ -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3><i class="bi bi-activity"></i> 監視とログ管理</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5><i class="bi bi-graph-up"></i> アプリケーション監視</h5>
                        <div class="code-block">
                            <pre><code class="language-csharp">// Application Insights設定
builder.Services.AddApplicationInsightsTelemetry();

// カスタムメトリクス
public class OrderMetrics
{
    private readonly TelemetryClient _telemetryClient;
    
    public OrderMetrics(TelemetryClient telemetryClient)
    {
        _telemetryClient = telemetryClient;
    }
    
    public void TrackOrderCreated(decimal amount)
    {
        _telemetryClient.TrackEvent("OrderCreated", 
            properties: new Dictionary&lt;string, string&gt; 
            {
                ["Amount"] = amount.ToString()
            });
        
        _telemetryClient.TrackMetric("OrderValue", (double)amount);
    }
    
    public void TrackOrderFailure(string reason)
    {
        _telemetryClient.TrackEvent("OrderFailed",
            properties: new Dictionary&lt;string, string&gt;
            {
                ["Reason"] = reason
            });
    }
}</code></pre>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5><i class="bi bi-file-text"></i> 構造化ログ</h5>
                        <div class="code-block">
                            <pre><code class="language-csharp">// Serilog設定
builder.Host.UseSerilog((context, configuration) =>
{
    configuration
        .ReadFrom.Configuration(context.Configuration)
        .WriteTo.Console()
        .WriteTo.File("logs/app-.txt", rollingInterval: RollingInterval.Day)
        .WriteTo.ApplicationInsights(TelemetryConverter.Traces);
});

// 構造化ログの使用
public class ProductService
{
    private readonly ILogger&lt;ProductService&gt; _logger;
    
    public async Task&lt;Product&gt; CreateProductAsync(CreateProductRequest request)
    {
        _logger.LogInformation("Creating product {ProductName} in category {CategoryId}",
            request.Name, request.CategoryId);
            
        try
        {
            var product = await _repository.CreateAsync(request);
            
            _logger.LogInformation("Product created successfully {ProductId}",
                product.Id);
                
            return product;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to create product {ProductName}",
                request.Name);
            throw;
        }
    }
}</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 次のステップ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3><i class="bi bi-arrow-right-circle"></i> 次に学ぶべきこと</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="next-topic">
                            <i class="bi bi-gear-wide-connected text-primary display-4"></i>
                            <h5>応用トピック</h5>
                            <p>マイクロサービス、キャッシュ、API設計などの高度な技術</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="next-topic">
                            <i class="bi bi-shield-check text-success display-4"></i>
                            <h5>セキュリティ強化</h5>
                            <p>本番環境でのセキュリティ対策と監査</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="next-topic">
                            <i class="bi bi-speedometer text-warning display-4"></i>
                            <h5>パフォーマンス最適化</h5>
                            <p>スケーラビリティとレスポンス時間の改善</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- アクション -->
<div class="text-center">
    <div class="d-grid gap-2 d-md-block">
        <button class="btn btn-success btn-lg me-2" onclick="app.markPageAsCompleted('deployment')">
            <i class="bi bi-check-circle"></i> 理解完了
        </button>
        <button class="btn btn-primary btn-lg" onclick="app.navigateNext()">
            <i class="bi bi-arrow-right"></i> 応用トピックへ進む
        </button>
    </div>
</div>

<style>
.deployment-stats {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
}

.deployment-stats.success {
    background: #d4edda;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding: 8px;
    background: white;
    border-radius: 5px;
    border-left: 4px solid #dc3545;
}

.stat-item.success {
    border-left-color: #28a745;
}

.stat-item.danger {
    border-left-color: #dc3545;
}

.stat-number {
    font-weight: bold;
    font-size: 1.1em;
}

.stat-item.success .stat-number {
    color: #28a745;
}

.stat-item.danger .stat-number {
    color: #dc3545;
}

.stat-desc {
    color: #6c757d;
    font-size: 0.9em;
}

.pipeline-flow {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    margin: 20px 0;
}

.pipeline-stage {
    display: flex;
    align-items: center;
    margin: 5px;
}

.stage-box {
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    min-width: 120px;
    color: white;
}

.stage-box.commit {
    background: #17a2b8;
}

.stage-box.build {
    background: #ffc107;
    color: #212529;
}

.stage-box.test {
    background: #28a745;
}

.stage-box.deploy {
    background: #dc3545;
}

.stage-box i {
    font-size: 1.5em;
    display: block;
    margin-bottom: 5px;
}

.stage-box h6 {
    margin: 5px 0;
    font-weight: 600;
}

.stage-arrow {
    font-size: 1.5em;
    color: #6c757d;
    margin: 0 10px;
}

.environment-stages {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.env-stage {
    padding: 15px;
    border-radius: 8px;
    border: 2px solid #dee2e6;
}

.env-stage.development {
    border-color: #17a2b8;
    background: #e7f5f7;
}

.env-stage.staging {
    border-color: #ffc107;
    background: #fff9e6;
}

.env-stage.production {
    border-color: #28a745;
    background: #e7f5e7;
}

.env-stage h6 {
    margin-bottom: 10px;
    font-weight: 600;
}

.env-stage ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.env-stage li {
    padding: 2px 0;
    color: #6c757d;
    font-size: 0.9em;
}

.docker-stages {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    margin: 15px 0;
}

.docker-stage {
    padding: 10px 15px;
    background: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    text-align: center;
    margin: 5px;
}

.stage-name {
    font-weight: 600;
    color: #495057;
    display: block;
}

.docker-stage small {
    color: #6c757d;
    font-size: 0.8em;
}

.next-topic {
    text-align: center;
    padding: 20px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    height: 100%;
    transition: transform 0.2s;
}

.next-topic:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.next-topic h5 {
    margin: 15px 0 10px 0;
    color: #495057;
}

@media (max-width: 768px) {
    .pipeline-flow, .docker-stages {
        flex-direction: column;
    }
    
    .stage-arrow {
        transform: rotate(90deg);
        margin: 10px 0;
    }
}
</style>